<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<title></title>
		<link rel="stylesheet" type="text/css" href="css/main.css"/>
		<style type="text/css">
		.history_total_table th,.history_total_table td{min-width: auto;}
		.history_total_table td{padding-left: 3px;padding-right: 3px;}
		.group_class th{font-size: 14px;}
		</style>
	</head>
	<body>
		<!--後臺表-->
		<section class="backstage_wrap">
			<div class="backstage_box">
				<h2>歷史列隊匯總表</h2>
				<!--數據表-->
				<div class="clearfix history_total_table" style="overflow-x: scroll;">
					
					<!--第壹組-->
					<table border="1" style="">
						<tr><th rowspan="2">序號</th><th colspan="50">列隊結果</th>
						<th rowspan="2" class="red"><a title="導出表格" href="javascript:tableExport()">全表導出</a></th>
						</tr>
						<tr class="group_class">
					    	<th>1</th>
							<th>2</th>
							<th>3</th>
							<th>4</th>
							<th>5</th>
							<th>6</th>
							<th>7</th>
							<th>8</th>
							<th>9</th>
							<th>10</th>
							<th>11</th>
							<th>12</th>
							<th>13</th>
							<th>14</th>
							<th>15</th>
							<th>16</th>
							<th>17</th>
							<th>18</th>
							<th>19</th>
							<th>20</th>
							<th>21</th>
							<th>22</th>
							<th>23</th>
							<th>24</th>
							<th>25</th>
							<th>26</th>
							<th>27</th>
							<th>28</th>
							<th>29</th>
							<th>30</th>
							<th>31</th>
							<th>32</th>
							<th>33</th>
							<th>34</th>
							<th>35</th>
							<th>36</th>
							<th>37</th>
							<th>38</th>
							<th>39</th>
							<th>40</th>
							<th>41</th>
							<th>42</th>
							<th>43</th>
							<th>44</th>
							<th>45</th>
							<th>46</th>
							<th>47</th>
							<th>48</th>
							<th>49</th>
							<th>50</th>
						</tr>
					  	<!--數據行--001-->
					  	<tbody id="main_group">
					  	<tr>
					  		<th>1</th>
					  		<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<th class="red"></th>
					  	</tr>
						<tr>
					  		<th>2</th>
					  		<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<th class="red"></th>
					  	</tr>
						<!--統計-->
						<tr class="tr_red">
							<th>匯總合計</th>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<th colspan=""></th>
						</tr>
						</tbody>
						<tr>
							<th colspan="1">序號</th>
							<th>1</th>
							<th>2</th>
							<th>3</th>
							<th>4</th>
							<th>5</th>
							<th>6</th>
							<th>7</th>
							<th>8</th>
							<th>9</th>
							<th>10</th>
							<th>11</th>
							<th>12</th>
							<th>13</th>
							<th>14</th>
							<th>15</th>
							<th>16</th>
							<th>17</th>
							<th>18</th>
							<th>19</th>
							<th>20</th>
							<th>21</th>
							<th>22</th>
							<th>23</th>
							<th>24</th>
							<th>25</th>
							<th>26</th>
							<th>27</th>
							<th>28</th>
							<th>29</th>
							<th>30</th>
							<th>31</th>
							<th>32</th>
							<th>33</th>
							<th>34</th>
							<th>35</th>
							<th>36</th>
							<th>37</th>
							<th>38</th>
							<th>39</th>
							<th>40</th>
							<th>41</th>
							<th>42</th>
							<th>43</th>
							<th>44</th>
							<th>45</th>
							<th>46</th>
							<th>47</th>
							<th>48</th>
							<th>49</th>
							<th>50</th>
							<th ><a href="javascript:toDel(2,null)">全選刪除</a></th>
							
							
							
						</tr>
						
					</table>
					
				</div>
			</div>
			
		</section>
		
	</body>
	<script type="text/javascript" src="../js/jquery-1.12.4.min.js" ></script>
	<script type="text/javascript" src="../js/template-web.js"></script>
	<script type="text/javascript" src="../js/app.js"></script>
	<script type="text/javascript" src="../layui/layui.all.js"></script>
	<script type="text/javascript" src="js/gameCore.js"></script>
	
		<script type="text/javascript" src="../js/tableExport.min.js"></script>
	<script type="text/javascript" src="../js/jquery.base64.js"></script>
	
	<script type="text/javascript">
	
	$(function(){
		$app.request("../allTgData.do",function(json){
		

			var list = json.map.his;

//todo
			var bigTurns = json.map.bigTurns;
			var turns = json.map.turns;
//todo
			var turnMap = {};
			for (var i = 0; i < turns.length; i++) {
				turnMap[turns[i].id] = turns[i];
			}
			
			var mod = {};
			for (var i = 0; i < list.length; i++) {
				var tid = list[i].tid;
				if(!mod[tid])mod[tid] = {tid:tid,list:[]};
				var qs = addData(list[i].queue_count);
				var n = mod[tid].list.length>qs.length?mod[tid].list.length:qs.length;
				for (var j = 0; j < n; j++) {
					if(isNaN(mod[tid].list[j]))mod[tid].list[j] = 0;
					mod[tid].list[j]+=(isNaN(qs[j])?0:qs[j]);
				}
			}




			var newMod = {};
			for(var i in bigTurns){
			 newMod[bigTurns[i].id] = {tid:bigTurns[i].id,list:[]};
			}

			for(var i in mod){
				
				var bMod = newMod[turnMap[mod[i].tid].big_turn_id];
			 //var bMod = newMod['43'];
			 for (var j = 0; j < mod[i].list.length; j++) {
					if(isNaN(bMod.list[j]))bMod.list[j] = 0;
					bMod.list[j]+=mod[i].list[j];

				 }

			}

			
			rdTb(newMod);
			
		},{});
		
		
	});
	
	function rdTb(mod){
		
		var yCount = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
		var html = "";
		var allCount = 0;
		for ( var i in mod) {
			var item = mod[i];
			var xCount = 0;
			html += '<tr><th>'+item.tid+'</th>';
			for (var i = 0; i < 50; i++) {
				html+='<td>'+(isNaN(item.list[i])?'':item.list[i])+'</td>'
				if(isNaN(item.list[i]))continue;
				xCount+=item.list[i];
				yCount[i]+=item.list[i];
			} 
			allCount+=xCount;
			html+='<th ><a href="javascript:toDel(1,'+item.tid+')">刪除</a></th></tr>'
			
		}
		
		html+='<tr class="tr_red"><th>結果匯總</th>';
							
		for (var i = 0; i < yCount.length; i++) {
			html+='<td>'+yCount[i]+'</td>';
		}
		html+='<th colspan="1">'+allCount+'</th></tr>';
		$("#main_group").html(html);
	}
	
	
	function addData(qc){
		if(!qc)return [];
		var qcs = qc.split(",");
		for (var i = 0; i < qcs.length; i++) {
			var n = new Number(qcs[i]);
			qcs[i]=n;
		}
		return qcs;
		
	}
	
	
function  toDel(mod,tid){
		
		layer.confirm(mod==1?'確定刪除全部記錄？':'確定刪除('+tid+')？', {
			  btn: ['是','否'] //按鈕
			}, function(i){
				layer.close(i);
				$app.request("../delHis.do",function(json){
					
					if(json.code==100){
						window.location.reload();
					}
					else alert(json.message);
					
				},{param:{mod:mod,tid:tid}})
			}, function(){
			  
			});
		
	}
	
	
	
	
	function tableExport(){
		layer.confirm('確認導出表格？', {
			  btn: ['是','否'] //按鈕
			}, function(i){
				layer.close(i);
				var tb = $("table");
				tb.tableExport({type:'excel',ignoreColumn: [],ignoreRow:[]
					, separator:';', escape:'false'
						 ,formats: ['xlsx']
				,fileName: '歷史列隊匯總表-'+new Date().format("yyyy-MM-dd")});
			}, function(){
			  
			});
		
		
	}
	
	
	</script>
</html>
