<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<title></title>
		<link rel="stylesheet" type="text/css" href="css/main.css"/>
		<style>
	
	.table-head{/* padding-right:17px; */left:0px;top:0px;position:relative;overflow-y:scroll;}
	.table-body{width:100%; height:480px;overflow-y:scroll;}
	.table-head table,.table-body table{width:100%;}
	
	
	</style>
	</head>
	<body>
		<!--後臺表-->
		<section class="backstage_wrap">
			<div class="backstage_box">
				<!--<h2>後臺表</h2>-->
				<!--數據表-->
				<div class="backtable_wrap clearfix total_table">
					<div class="table-head">
						<table border="1" class="total_table_con" style="table-layout: fixed;">
							<tr><th colspan="1">編號</th><th colspan="1"><select id="history_group"  onchange="selectHistory()"></select></th><th colspan="20" rowspan="2" class="title">匯總表</th></tr>
							<tr><th colspan="1">序號</th><th colspan="1" id="focus_row">--</th></tr>
							<tr class="group_class">
								<th colspan="2">組</th>
						    	<th colspan="2">第 <span class="red">1</span> 戶</th>
						    	<th colspan="2">第 <span class="red">2</span> 戶</th>
						    	<th colspan="2">第 <span class="red">3</span> 戶</th>
						    	<th colspan="2">第 <span class="red">4</span> 戶</th>
						    	<th colspan="2">第 <span class="red">5</span> 戶</th>
						    	<th colspan="2">第 <span class="red">6</span> 戶</th>
						    	<th colspan="2">第 <span class="red">7</span> 戶</th>
						    	<th colspan="2">第 <span class="red">8</span> 戶</th>
						    	<th colspan="2">第 <span class="red">9</span> 戶</th>
						    	<th colspan="2">第 <span class="red">10</span> 戶</th>
							</tr>
						</table>
					</div>
					<div class="table-body">
					<!--第壹組-->
					<table border="1" class="total_table_con" style="table-layout: fixed;margin-top: 0px;">
						
					  	<!--數據行--001-->
					  	<tbody id="main_group">
						</tbody>
					  	<!-- <tr>
					  		<th colspan="2">1</th>
					  		<td class="bg_g">-3</td>
							<td class="bg_r">2</td>
							<td>2</td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
					  	</tr> -->
						<!--統計-->
						<tr>
						<th colspan="2">列隊統計</th><th colspan="20" class="red" id="sum_group">--</th></tr>
						<tr class="child_tr">
							<th colspan="2" rowspan="4">列隊結果</th>
						<td>1</td>
						<td>2</td>
						<td>3</td>
						<td>4</td>
						<td>5</td>
						<td>6</td>
						<td>7</td>
						<td>8</td>
						<td>9</td>
						<td>10</td>
						<td>11</td>
						<td>12</td>
						<td>13</td>
						<td>14</td>
						<td>15</td>
						<td>16</td>
						<td>17</td>
						<td>18</td>
						<td>19</td>
						<td>20</td>
						</tr>
						<tr class="child_tr_red" id="result_1"><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td></tr>
						<tr class="child_tr">
						<td>21</td>
						<td>22</td>
						<td>23</td>
						<td>24</td>
						<td>25</td>
						<td>26</td>
						<td>27</td>
						<td>28</td>
						<td>29</td>
						<td>30</td>
						<td>31</td>
						<td>32</td>
						<td>33</td>
						<td>34</td>
						<td>35</td>
						<td>36</td>
						<td>37</td>
						<td>38</td>
						<td>39</td>
						<td>40</td></tr>
						<tr class="child_tr_red" id="result_2"><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td><td class="red"></td></tr>
					
					</table>
					</div>
						
					
					
				</div>
			</div>
			
		</section>
		
	<script type="text/javascript" src="../js/jquery-1.12.4.min.js" ></script>
	<script type="text/javascript" src="../js/template-web.js"></script>
	<script type="text/javascript" src="../js/app.js"></script>
	<script type="text/javascript" src="../layui/layui.all.js"></script>
	<script type="text/javascript" src="js/gameCore.js"></script>
		<script type="text/javascript">
			//			元素置頂
			$(".group_btn_box a").click(function(){
				$('.layui-body').animate({scrollTop: '0px'}, 800);
			});
			
		</script>
		<script type="text/javascript">
		$(function(){
			$app.request("../history.do",function(json){
				var user = json.map.data.user;
				var history = json.map.data.history||[];
				var html = "";
				var hdata = {};
				var runGame;
				for (var i = 0; i < history.length; i++) {
					var st = "已結束";
					if(history[i].state==1)st="進行中"; 
					html+='<option value='+history[i].id+' data-frow="'+history[i].focus_row+'">'+history[i].id+'('+st+')</option>';
					if(history[i].state==1)runGame = history[i];
					hdata[history[i].id] = history[i];
				}
				
				
				$("#history_group").html(html);
				$("#history_group").data("hdata",hdata);
				
				//$("#detail_group").html("ID :"+user.djt_u_id+"   用戶名 :"+user.djt_u_name+"  正在使用的工作表 : 第<span id='tbNum'>--</span>張")
				
				if(!runGame)alert("沒有正在工作的表格");
				else selectHistory();
				
			},{param:{uid:$app.getQueryStr("uid")}})
			
			
		});
		
		
		function selectHistory(){
			var index = layer.load(1, {
				  shade: [0.5,'#555'] //0.1透明度的白色背景
				});
			
			var hid = $("#history_group").val();
			var h = $("#history_group").data("hdata")[hid];
			if(!h){
				alert("錯誤");
				return;
			} 
			var frow = $("#history_group>option[value="+h.id+"]").attr("data-frow");
			$("#focus_row").html(frow<3?0:(frow-2));
			
			$app.request("../totalData.do",function(json){
				layer.close(index);
				renderTb(json.map)
				
			},{param:{hid:hid}})
			
			
		}
		
		function renderTb(map){
			
			var qs = map.count[0].queue.split(",");
			var html = ""
			for (var i = 0; i < qs.length; i++) {
				html+='<tr><td colspan="2">'+(i+1)+'</td>'; 
				for (var j = 0; j < gameCore.HU_NUM; j++) {
					var zf = qs[i].substring(j*gameCore.ITEM_LENGTH,j*gameCore.ITEM_LENGTH+1);
					var num = new Number(qs[i].substring(j*gameCore.ITEM_LENGTH+1,(j+1)*gameCore.ITEM_LENGTH));
					if(zf=="0"||num<6){
						html+=("<td></td>");
						continue;
					}
					html+=('<td class="'+(zf=="+"?'bg_r':'bg_g')+'">'+num+'</td>');
					
				}
				html+="</tr>";
			}
			
			$("#main_group").html(html);
			
			var html2 ="";
			var html3 = '';
			var sum = 0;
			var qcs = map.count[0].queue_count.split(",");
			for (var i = 0; i < 40; i++) {
				var v =new Number(qcs[i]?qcs[i]:0);
				v = (v==0?"":v);
				if(i<20)
				html2+='<td class="red">'+v+'</td>'; 
				else html3+='<td class="red">'+v+'</td>'; 
				sum+=v;
			}
			$("#result_1").html(html2);
			$("#result_2").html(html3);
			$("#sum_group").html(sum);
			
		}
		
		</script>

		
	</body>
</html>
