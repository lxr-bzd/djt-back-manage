<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<title></title>
		<link rel="stylesheet" type="text/css" href="css/main.css"/>
	</head>
	<style>
	
	.table-head{/* padding-right:17px; */left:0px;top:0px;position:relative;overflow-y:scroll;}
	.table-body{width:100%; height:480px;overflow-y:scroll;}
	.table-head table,.table-body table{width:100%;}
	
	.group_class th{font-size: 14px;}
	
	.style_group>th{height: 1px;}
	
	</style>
	<body >
		<!--後臺表-->
		<section class="backstage_wrap" style="overflow-x:scroll;text-align:left;">
			<div class="backstage_box" style="display: inline-block;text-align:center;">
				<h2>歷史結果匯總表</h2>
				<!--數據表-->
				
				<div class="clearfix history_total_table" style="display: inline-block;">
					<div class="table-head" style="width:auto;">
				    <table border="1" style="table-layout: fixed;">
				        <colgroup>
				            <col style="width: 70px;" />
				        </colgroup>
				        <thead>
				        	
				            <tr class="group_class">
							<th>序號</th>
							<!-- <th>1</th> -->
							</tr>
				        </thead>
				    </table>
   				 </div>
   				 <div class="table-body" >
					<!--第壹組-->
					<table border="1" style="table-layout: fixed;">
						<colgroup >
				            <col style="width: 70px;" />
				        </colgroup>
					  	<!--數據行--001-->
					  	<tbody id="main_group">
					  	<tr>
					  		<td>1</td>
					  		<!-- <td></td> -->
					  	</tr>
						<tr>
					  		<td>2</td>
					  		<!-- <td></td> -->
					  	</tr>
					  	</tbody>
						
					</table>
					</div>
				</div>
			</div>
			
		</section>
		
	</body>
	<script type="text/javascript" src="../js/jquery-1.12.4.min.js" ></script>
	<script type="text/javascript" src="../js/template-web.js"></script>
	<script type="text/javascript" src="../js/app.js"></script>
	<script type="text/javascript" src="../layui/layui.all.js"></script>
	<script type="text/javascript" src="js/gameCore.js"></script>
	
	<script type="text/javascript" src="../js/tableExport.min.js"></script>
	<script type="text/javascript" src="../js/jquery.base64.js"></script>
	
	<script type="text/javascript">
	
	$(function(){
		$app.request("../allTgData.do",function(json){
			var list= json.map.list;
			var turns = json.map.turns;
			var tus = {};
			for (var i = 0; i < turns.length; i++) {
				tus[turns[i].id] = turns[i];
			}
			
			var md = {};
			for (var j = 0; j < list.length; j++) {
				if(!md[list[j].tid])md[list[j].tid] = {list:[],sums:[],ys:0,qh:0};
				var m = md[list[j].tid];
				
				m.ys+=list[j].ys;
				var ts = (list[j].tg?list[j].tg.split(","):null)||[];
				for (var i = 0; i < ts.length; i++) {
					if(ts[i]){
						var t2 = ts[i].split("_");
						var n = new Number(t2[0])+new Number(t2[1]);
						
						if(!m.list[i])m.list[i]=0;
						m.list[i]+=n;
					}
				}
			}
			
			for ( var j in md) {
				
				var list = md[j].list;
				var sums = md[j].sums;
				md[j].qh = 0;
				md[j].hb = tus[j].hb_jg_sum;
				md[j].lj = tus[j].lj;
				md[j].qhgj = tus[j].qh_sum;
				md[j].yzgj = tus[j].yz_sum;
				md[j].hbgj = tus[j].hb_sum;
				md[j].hbqhgj = tus[j].hbqh_sum;
				md[j].xzgj = tus[j].xz_sum;
				
				md[j].yzData = getYzData(tus[j]);
				if(list.length>0)
				for (var i = 0; i < list.length; i++) {
					if(sums.length<1)sums.push(list[i]);
					else sums.push(list[i]+sums[sums.length-1]);
					md[j].qh+=(list[i]>0?1:(list[i]<0?-1:0));
				}
			}
			
		
			
			
			//渲染表頭
			var colHtml = ' <col style="width: 80px;" />';
			var html = '<th>序號</th>';
			var colNum = 1;
			for (var i in md) {
				colNum++;
				html+='<th colspan="2">'+i+'</th>';
				colHtml+=' <col style="width: 70px;" /><col style="width: 70px;" />';
			}
			colHtml+=' <col style="width: 80px;" />';
			$('.group_class').html(html+'<th>序號</th>');
			
			$('.group_class').parent().parent().find('colgroup').html(colHtml);
			
			html ='';
			
			for (var i = 0; i < 210; i++) {
				html +='<tr><td>'+(i+1)+'</td>';
				for (var j in md) {
					var v = md[j].list[i];
					var vm = md[j].sums[i];
					html+='<td '+(v>0?'class="red"':'')+'>'+(isNaN(v)?'':v)+'</td>'+
					'<td '+(vm>0?'class="red"':'')+'>'+(isNaN(vm)?'':vm)+'</td>';
				}
				html+=('<td>'+(i+1)+'</td></tr>');
			}
			
			var ysHtml ='<tr><td>原值</td>';
			var jgHtml ='<tr><td>结果</td>';
			var qhHtml ='<tr><td>求和</td>';
			var hbHtml ='<tr><td>合并</td>';
			var ljHtml ='<tr><td>供計</td>';
			
			var qhgjHtml ='<tr><td>求和供計</td>';
			var yzgjHtml ='<tr><td>原值供計</td>';
			var hbgjHtml ='<tr><td>合并供計</td>';
			var hbqhgjHtml ='<tr><td>合并求和供計</td>';
			var xzgjHtml ='<tr><td>選擇供計</td>';
			
			var delHtml ='<tr><td><a href="javascript:toDel(1,null)">全選刪除</a></td>';
			var allLj = 0;
			var allJg = 0;
			var allYz = 0;
			var allQh = 0;
			var allHb = 0;
			
			var allQhgj = 0;
			var allYzgj = 0;
			var allHbgj = 0;
			var allHbqhgj = 0;
			var allXzgj = 0;
			
			
			for (var j in md) {
				var sums = md[j].sums
				var v = sums.length>0?sums[sums.length-1]:0;
				allJg+=v;
				allLj+=md[j].lj;
				allYz+=md[j].yzData[1].sum;
				allQh+=md[j].qh;
				allHb+=md[j].hb;
				
				allQhgj += md[j].qhgj;    
				allYzgj += md[j].yzgj;    
				allHbgj += md[j].hbgj;  
				allHbqhgj += md[j].hbqhgj;  
				allXzgj += md[j].xzgj;
				
				ysHtml+='<td colspan="2" '+(md[j].yzData[1].sum>0?'class="red"':'')+'>'+(md[j].yzData[1].sum)+'</td>';
				jgHtml+='<td colspan="2" '+(v>0?'class="red"':'')+'>'+(v)+'</td>';
				qhHtml+='<td colspan="2" '+(md[j].qh>0?'class="red"':'')+'>'+(md[j].qh)+'</td>';
				hbHtml+='<td colspan="2" '+(md[j].hb>0?'class="red"':'')+'>'+md[j].hb+'</td>';
				ljHtml+='<td colspan="2" '+(md[j].lj>0?'class="red"':'')+'>'+md[j].lj+'</td>';
				
				qhgjHtml +='<td colspan="2" '+(md[j].qhgj>0?'class="red"':'')+'>'+(md[j].qhgj)+'</td>';                                    
				yzgjHtml +='<td colspan="2" '+(md[j].yzgj>0?'class="red"':'')+'>'+(md[j].yzgj)+'</td>';                      
				hbgjHtml +='<td colspan="2" '+(md[j].hbgj>0?'class="red"':'')+'>'+md[j].hbgj+'</td>';                        
				hbqhgjHtml +='<td colspan="2" '+(md[j].hbqhgj>0?'class="red"':'')+'>'+md[j].hbqhgj+'</td>';                        
				xzgjHtml +='<td colspan="2" '+(md[j].xzgj>0?'class="red"':'')+'>'+md[j].xzgj+'</td>';                        
				
				
				delHtml+='<td colspan="2"><a href="javascript:toDel(2,'+j+')">刪除</a></td>';
			}
			ysHtml+='<td>原值</td></tr>';
			jgHtml+='<td>结果</td></tr>';
			qhHtml+='<td>求和</td></tr>';
			ljHtml+='<td>供計</td></tr>';
			hbHtml+='<td>合并</td></tr>';
			
			qhgjHtml +='<td>求和供計</td></tr>';    
			yzgjHtml +='<td>原值供計</td></tr>';    
			hbgjHtml +='<td>合并供計</td></tr>';    
			hbqhgjHtml +='<td>合并求和供計</td></tr>';
			xzgjHtml +='<td>選擇供計</td></tr>';
			                                            
			delHtml+='<td><a href="javascript:toDel(1,null)">全選刪除</a></td></tr>';
			
			$('#main_group').html(html
								+ysHtml+'<tr><td>原值匯總</td><td colspan="'+(colNum*2-2)+'" '+(allYz>0?'class="red"':'')+'>'+allYz+'</td><td>原值匯總</td></tr>'
								+jgHtml+'<tr><td>結果匯總</td><td colspan="'+(colNum*2-2)+'" '+(allJg>0?'class="red"':'')+'>'+allJg+'</td><td>結果匯總</td></tr>'
								+qhHtml+'<tr><td>求和匯總</td><td colspan="'+(colNum*2-2)+'" '+(allQh>0?'class="red"':'')+'>'+allQh+'</td><td>求和匯總</td></tr>'
								+hbHtml+'<tr><td>合并匯總</td><td colspan="'+(colNum*2-2)+'" '+(allHb>0?'class="red"':'')+'>'+allHb+'</td><td>合并匯總</td></tr>'
								+ljHtml+'<tr><td>供計匯總</td><td colspan="'+(colNum*2-2)+'" '+(allLj>0?'class="red"':'')+'>'+allLj+'</td><td>供計匯總</td></tr>'
								
								+qhgjHtml + '<tr><td>求和供計匯總</td><td colspan="'+(colNum*2-2)+'" '+(allQhgj>0?'class="red"':'')+'>'+allQhgj+'</td><td>求和供計匯總</td></tr>'
								+yzgjHtml + '<tr><td>原值供計匯總</td><td colspan="'+(colNum*2-2)+'" '+(allYzgj>0?'class="red"':'')+'>'+allYzgj+'</td><td>原值供計匯總</td></tr>'
								+hbgjHtml + '<tr><td>合并供計匯總</td><td colspan="'+(colNum*2-2)+'" '+(allHbgj>0?'class="red"':'')+'>'+allHbgj+'</td><td>合并供計匯總</td></tr>'
								+hbqhgjHtml + '<tr><td>合并求和供計匯總</td><td colspan="'+(colNum*2-2)+'" '+(allHbqhgj>0?'class="red"':'')+'>'+allHbqhgj+'</td><td>合并求和供計匯總</td></tr>'
								+xzgjHtml + '<tr><td>選擇供計匯總</td><td colspan="'+(colNum*2-2)+'" '+(allXzgj>0?'class="red"':'')+'>'+allXzgj+'</td><td>選擇供計匯總</td></tr>'
								
								
								+delHtml+'<tr><td colspan="'+(colNum*2)+'"><a href="javascript:tableExport()">全表導出</a></td></tr>');
			$('#main_group').parent().find('colgroup').html(colHtml);
			
			$('.table-head').css('width',(colNum*140+160)+'px')
			$('.table-body').css('width',(colNum*140+160)+'px')
			
			
		},{param:{uid:$app.getQueryStr("uid")}})
		
		
	});
	
	
	
	function getYzData(turn){
		
		/* 开始处理原值数据 */
		var yzData = [[{},{},0],{list:[null],sum:0,qh:0}];
		var yzjgs = turn.yz_jg?turn.yz_jg.split(","):[];
		for (var i = 0; i < yzjgs.length; i++) {
			if(!yzjgs[i])continue;
			var v = new Number(yzjgs[i]);
			yzData[1].list.push(v);
			yzData[1].sum+=v;
			yzData[1].qh+=(v>0?1:(v<0?-1:0));
		}
		
		return yzData;
		/* 结束处理原值数据 */
	}
	
	
	function  toDel(mod,tid){
		
		layer.confirm(mod==1?'確定刪除全部記錄？':'確定刪除('+tid+')？', {
			  btn: ['是','否'] //按鈕
			}, function(i){
				layer.close(i);
				$app.request("../delHis.do",function(json){
					
					if(json.code==100){
						window.location.reload();
					}
					else alert(json.message);
					
				},{param:{mod:mod,tid:tid}})
			}, function(){
			  
			});
		
		
		
	}
	
	
	function tableExport(){
		layer.confirm('確認導出表格？', {
			  btn: ['是','否'] //按鈕
			}, function(i){
				layer.close(i);
				var th = $('<tr>'+$(".group_class").html()+'</tr>')
				var tb = $('#main_group').parent();
				$('#main_group').prepend(th);
				tb.tableExport({type:'excel',ignoreColumn: [],ignoreRow:[]
					, separator:';', escape:'false'
						 ,formats: ['xlsx']
				,fileName: '歷史結果匯總表-'+new Date().format("yyyy-MM-dd")});
				th.remove()
			}, function(){
			  
			});
		
		
	}
	
	
	</script>
	
	
	
</html>
